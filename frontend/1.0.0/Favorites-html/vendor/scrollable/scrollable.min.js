angular.module("ngScrollable",[]).directive("ngScrollable",["$injector",function(e){"use strict";var l=e.get("$document"),n=e.get("$interval"),t=e.get("$timeout"),o=e.get("$window"),a=e.get("$parse"),s=angular.bind,r=angular.extend,i=angular.element,c=(angular.isDefined,"undefined"!=typeof o.ontouchstart),u="transform",d=o.requestAnimationFrame||o.webkitRequestAnimationFrame,f=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver;["webkit","moz","o","ms"].every(function(e){var n=e+"Transform",t=l.find("body").eq(0);return"undefined"!=typeof t[0].style[n]?(u=n,!1):!0});var p={id:0,scrollX:"bottom",scrollY:"right",scrollXSlackSpace:0,scrollYSlackSpace:0,scrollXAlways:!1,scrollYAlways:!1,usePadding:!1,useObserver:!0,wheelSpeed:1,minSliderLength:10,useBothWheelAxes:!1,useKeyboard:!0,preventKeyEvents:!0,updateOnResize:!0,kineticTau:325,spyMargin:1};return{restrict:"A",transclude:!0,template:"<div class=\"scrollable\"><div class=\"scrollable-content\" ng-transclude></div><div class='scrollable-bar scrollable-bar-x'><div class='scrollable-slider'></div></div><div class='scrollable-bar scrollable-bar-y'><div class='scrollable-slider'></div></div></div>",link:function(e,h,v){var b,m,g,y,w,$=r({},p,e.$eval(v.ngScrollable)),X=i(h.children()[0]),Y={window:i(o),el:X,content:i(X.children()[0]),barX:i(X.children()[1]),barY:i(X.children()[2]),sliderX:i(i(X.children()[1]).children()[0]),sliderY:i(i(X.children()[2]).children()[0])},k=!1,C=!1,M=0,S=0,A=0,T=0,x=0,D=0,I=0,E=0,K=0,O=0,z=null,L=null,N=null,P=null,R=!1,W=!1,H=!1,B={},F=1,q=0,j=0,U=0,V=0,G=0,J=0,Q=0,Z=0,_=function(e){return e.toFixed(3)+"px"},ee=function(e,l,n){return Math.max(l,Math.min(e,n))},le=function(){var l=e.$root?e.$root.$$phase:e.$$phase;"$apply"!==l&&"$digest"!==l&&e.$digest()},ne=function(){var e=M-3;k||$.scrollXAlways?(I=Math.max($.minSliderLength,parseInt(e*e/A,10)),E=parseInt(D*(e-I)/(A-e),10),E>=e-I?E=e-I:0>E&&(E=0),Y.sliderX[0].style[u]="translate3d("+_(E)+",0,0)",Y.sliderX[0].style.width=_(I)):(I=E=0,Y.sliderX[0].style[u]="translate3d(0,0,0)",Y.sliderX[0].style.width="0")},te=function(){var e=S-3;C||$.scrollYAlways?(K=Math.max($.minSliderLength,parseInt(e*e/T,10)),O=parseInt(x*(e-K)/(T-e),10),O>=e-K?O=e-K:0>O&&(O=0),Y.sliderY[0].style[u]="translate3d(0,"+_(O)+",0)",Y.sliderY[0].style.height=_(K)):(O=K=0,Y.sliderY[0].style[u]="translate3d(0,0,0)",Y.sliderY[0].style.height="0")},oe=function(){var e=$.scrollXAlways,l={left:0,width:_(M),display:k||e?"inherit":"none"};switch($.scrollX){case"bottom":l.bottom=0,Y.content[k||e?"addClass":"removeClass"]("scrollable-bottom"),Y.barX[k||e?"addClass":"removeClass"]("scrollable-bottom");break;case"top":l.top=0,Y.content[k||e?"addClass":"removeClass"]("scrollable-top"),Y.barX[k||e?"addClass":"removeClass"]("scrollable-top")}Y.barX.css(l),Y.sliderX[0].style.display=k||e?"inherit":"none"},ae=function(){var e=$.scrollYAlways,l={top:0,height:_(S),display:C||e?"inherit":"none"};switch($.scrollY){case"right":l.right=0,Y.content[C||e?"addClass":"removeClass"]("scrollable-right"),Y.barY[C||e?"addClass":"removeClass"]("scrollable-right");break;case"left":l.left=0,Y.content[C||e?"addClass":"removeClass"]("scrollable-left"),Y.barY[C||e?"addClass":"removeClass"]("scrollable-left")}Y.barY.css(l),Y.sliderY[0].style.display=C||e?"inherit":"none"},se=function(){var l=!1;B.spyX&&(B.spyX(e,parseInt(D,10)),l=!0),B.spyY&&(B.spyY(e,parseInt(x,10)),l=!0),l&&le()},re=function(l,n){var t=x,o=D;x=ee(n,0,T-S),D=ee(l,0,A-M),Y.content[0].style[u]="translate3d("+_(-D)+","+_(-x)+",0)",e.$applyAsync(se),S*$.spyMargin>x&&t>=S*$.spyMargin&&e.$broadcast("scrollable.spytop",x,$.id),x>T-S*($.spyMargin+1)&&T-S*($.spyMargin+1)>=t&&e.$broadcast("scrollable.spybottom",x,$.id),M*$.spyMargin>D&&o>=M*$.spyMargin&&e.$broadcast("scrollable.spyleft",D,$.id),D>A-M*($.spyMargin+1)&&A-M*($.spyMargin+1)>=o&&e.$broadcast("scrollable.spyright",D,$.id)},ie=function(e){k&&(re(e,x),ne())},ce=function(e){C&&(re(D,e),te())},ue=function(l,n){M=$.usePadding?Y.el[0].clientWidth:Y.el[0].offsetWidth,S=$.usePadding?Y.el[0].clientHeight:Y.el[0].offsetHeight,A=Y.content[0].scrollWidth,T=Y.content[0].scrollHeight,F=parseFloat(Y.window[0].getComputedStyle(Y.el[0],null).getPropertyValue("font-size")),"none"!==$.scrollX&&A>M+$.scrollXSlackSpace?k=!0:(ie(0),k=!1),"none"!==$.scrollY&&T>S+$.scrollYSlackSpace?C=!0:(ce(0),C=!1),oe(),ae(),ne(),te(),D+E+I>A&&ie(E),x+O+K>T&&ce(O),n||e.$broadcast("scrollable.dimensions",M,S,A,T,$.id)},de=function(e,l){return e.stopPropagation(),l&&e.preventDefault(),!1},fe=function(e){return e=e.originalEvent||e,e.targetTouches&&e.targetTouches.length>=1?e.targetTouches[0].pageY:e.pageY},pe=function(e){return e=e.originalEvent||e,e.targetTouches&&e.targetTouches.length>=1?e.targetTouches[0].pageX:e.pageX},he=function(){var e,l,n,t;e=Date.now(),l=e-y,y=e,n=D-U,U=D,t=1e3*n/(1+l),q=.8*t+.2*q,n=x-Q,Q=x,t=1e3*n/(1+l),G=.8*t+.2*G},ve=function(){var e,l;j&&(e=Date.now()-y,l=-j*Math.exp(-e/$.kineticTau),l>.5||-.5>l?(ie(V+l),d(ve)):ie(V))},be=function(){var e,l;J&&(e=Date.now()-y,l=-J*Math.exp(-e/$.kineticTau),l>.5||-.5>l?(ce(Z+l),d(be)):ce(Z))},me=function(e){return L=pe(e),z=D,R=!0,q=j=0,U=D,l.on("mousemove",ge),l.on("mouseup",ye),c&&!w&&(w=n(he,50)),Y.el.addClass("active"),c||de(e,!0)},ge=function(e){if(R){var l=pe(e)-L,n=c?-l:parseInt(l*(A-M)/(M-I),10);return d(s(null,ie,z+n)),de(e,!0)}},ye=function(e){return R&&(l.off("mousemove",ge),l.off("mouseup",ye),R=!1,Y.el.removeClass("active"),z=L=null),w&&(n.cancel(w),w=null),(q>10||-10>q)&&(j=.8*q,V=Math.round(D+j),y=Date.now(),d(ve)),c||de(e,!0)},we=function(e){return P=fe(e),N=x,W=!0,G=J=0,Q=x,l.on("mousemove",$e),l.on("mouseup",Xe),c&&!w&&(w=n(he,50)),Y.el.addClass("active"),c||de(e,!0)},$e=function(e){if(W){var l=fe(e)-P,n=c?-l:parseInt(l*(T-S)/(S-K),10);return d(s(null,ce,N+n)),c||de(e,!0)}},Xe=function(e){return W&&(l.off("mousemove",$e),l.off("mouseup",Xe),W=!1,Y.el.removeClass("active"),N=P=null),w&&(n.cancel(w),w=null),(G>10||-10>G)&&(J=.8*G,Z=Math.round(x+J),y=Date.now(),d(be)),c||de(e,!0)},Ye=function(e){var l=parseInt(I/2,10),n=e.clientX-Y.barX[0].getBoundingClientRect().left-l,t=M-I,o=ee(n/t,0,1);d(s(null,ie,(A-M)*o))},ke=function(e){var l=parseInt(K/2,10),n=e.clientY-Y.barY[0].getBoundingClientRect().top-l,t=S-K,o=ee(n/t,0,1);d(s(null,ce,(T-S)*o))},Ce=function(){H=!0},Me=function(){H=!1},Se=function(e){var n=0,t=0,o=30;if(!(!H||l[0].activeElement.isContentEditable||"INPUT"===l[0].activeElement.nodeName||e.altKey||e.ctrlKey||e.metaKey)){switch(e.which){case 37:n=-o;break;case 38:t=o;break;case 39:n=o;break;case 40:t=-o;break;case 33:t=S;break;case 32:case 34:t=-S;break;case 35:C&&!k?t=-T:n=S;break;case 36:C&&!k?t=T:n=-S;break;default:return}d(s(null,ce,x-t)),d(s(null,ie,D+n)),$.preventKeyEvents&&e.preventDefault()}},Ae=function(e){var l=e.explicitOriginalTarget||e.target;if(!l)return!1;if(l.isContentEditable)return l.scrollHeight>l.clientHeight+l.clientTop+10;for(;l;){if(l.className&&"string"==typeof l.className&&l.className.indexOf("scrollable-ignore")>-1)return!0;l=l.parentNode}return!1},Te=function(){var e=Date.now()-g;500>e?m=t(Te,500-e):(Y.el.removeClass("active"),m=null)},xe=function(e){return 0>=D+e||D+e>=A-M},De=function(e){return 0>=x+e||x+e>=T-S},Ie=function(e){if(e=e.originalEvent||e,!Ae(e)){var l=e.deltaMode?F:1,n=e.deltaX*l*$.wheelSpeed,o=e.deltaY*l*$.wheelSpeed,a=!0;if(e.shiftKey){var r=o;o=n,n=r}g=Date.now(),m||(Y.el.addClass("active"),m=t(Te,500)),$.useBothWheelAxes?C&&!k?o?(d(s(null,ce,x+o)),a=!De(o)):(d(s(null,ce,x+n)),a=!De(n)):k&&!C&&(n?(d(s(null,ie,D+n)),a=!xe(n)):(d(s(null,ie,D+o)),a=!xe(o))):(d(s(null,ce,x+o)),d(s(null,ie,D+n)),C&&(a=!De(0))),a&&de(e,!0)}},Ee=function(e){var l=Y.el[0].scrollTop,n=Y.el[0].scrollLeft;l&&d(s(null,ce,x+l+2)),n&&d(s(null,ie,D+n+2)),Y.el[0].scrollTop=Y.el[0].scrollLeft=0,de(e,!0)},Ke=function(){if($.useObserver&&f){var e={childList:!0,subtree:!0};b=new f(function(){d(ue)}),b.observe(Y.content[0],e)}$.updateOnResize&&Y.window.on("resize",ue),"none"!==$.scrollX&&(Y.sliderX.on("click",de),Y.barX.on("click",Ye),Y.sliderX.on("mousedown",me),c&&(Y.el.on("touchstart",me),Y.el.on("touchmove",ge),Y.el.on("touchend",ye))),"none"!==$.scrollY&&(Y.sliderY.on("click",de),Y.barY.on("click",ke),Y.sliderY.on("mousedown",we),c&&(Y.el.on("touchstart",we),Y.el.on("touchmove",$e),Y.el.on("touchend",Xe))),Y.el.on("wheel",Ie),Y.el.on("scroll",Ee),$.useKeyboard&&(Y.el.on("mouseenter",Ce),Y.el.on("mouseleave",Me),l.on("keydown",Se))},Oe=function(){b&&(b.disconnect(),b=null),$.updateOnResize&&Y.window.off("resize",ue),Y.sliderX.off("click",de),Y.barX.off("click",Ye),Y.sliderY.off("click",de),Y.barY.off("click",ke),c&&(Y.el.off("touchstart",me),Y.el.off("touchmove",ge),Y.el.off("touchend",ye),Y.el.off("touchstart",we),Y.el.off("touchmove",$e),Y.el.off("touchend",Xe)),Y.sliderX.off("mousedown",me),l.off("mousemove",ge),l.off("mouseup",ye),Y.sliderY.off("mousedown",we),l.off("mousemove",$e),l.off("mouseup",Xe),$.useKeyboard&&(Y.el.off("mouseenter",Ce),Y.el.off("mouseleave",Me),l.off("keydown",Se)),Y.el.off("wheel",Ie),Y.el.off("scroll",Ee)};e.$on("content.reload",function(e,l){Oe(),t(function(){Y.el=i(h.children()[0]),Y.content=i(Y.el.children()[0]),Ke(),ue(e,l)})}),e.$on("content.changed",function(e,l,n){l=l||100,t(function(){ue(e,n)},l),e.preventDefault()}),e.$on("scrollable.scroll.left",function(){e.$applyAsync(function(){ie(0)})}),e.$on("scrollable.scroll.right",function(){e.$applyAsync(function(){ie(A)})}),e.$on("scrollable.scroll.top",function(){e.$applyAsync(function(){ce(0)})}),e.$on("scrollable.scroll.bottom",function(){e.$applyAsync(function(){ce(T)})}),e.$on("$destroy",function(){t.cancel(m),Oe()}),Ke(),ue(),angular.forEach(["spyX","spyY"],function(l){v[l]&&(B[l]=a(v[l]).assign,e.$watch(v[l],function(e){switch(e=e||0,l){case"spyX":ie(e);break;case"spyY":ce(e)}}))})}}}]);